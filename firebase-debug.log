[debug] [2025-11-14T13:17:31.056Z] ----------------------------------------------------------------------
[debug] [2025-11-14T13:17:31.057Z] Command:       /Users/dragan/.nvm/versions/node/v20.19.2/bin/node /Users/dragan/.nvm/versions/node/v20.19.2/bin/firebase deploy --only firestore:rules
[debug] [2025-11-14T13:17:31.058Z] CLI Version:   14.24.2
[debug] [2025-11-14T13:17:31.058Z] Platform:      darwin
[debug] [2025-11-14T13:17:31.058Z] Node Version:  v20.19.2
[debug] [2025-11-14T13:17:31.058Z] Time:          Fri Nov 14 2025 14:17:31 GMT+0100 (Central European Standard Time)
[debug] [2025-11-14T13:17:31.058Z] ----------------------------------------------------------------------
[debug] 
[debug] [2025-11-14T13:17:31.166Z] > command requires scopes: ["email","openid","https://www.googleapis.com/auth/cloudplatformprojects.readonly","https://www.googleapis.com/auth/firebase","https://www.googleapis.com/auth/cloud-platform"]
[debug] [2025-11-14T13:17:31.167Z] > authorizing via signed-in user (drag.markovic@gmail.com)
[debug] [2025-11-14T13:17:31.167Z] [iam] checking project credit-castor for permissions ["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]
[debug] [2025-11-14T13:17:31.167Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:31.167Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:31.168Z] >>> [apiv2][query] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions [none]
[debug] [2025-11-14T13:17:31.168Z] >>> [apiv2][(partial)header] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions x-goog-quota-user=projects/credit-castor
[debug] [2025-11-14T13:17:31.168Z] >>> [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[debug] [2025-11-14T13:17:31.872Z] <<< [apiv2][status] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions 200
[debug] [2025-11-14T13:17:31.873Z] <<< [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[info] 
[info] === Deploying to 'credit-castor'...
[info] 
[info] i  deploying firestore 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[debug] [2025-11-14T13:17:31.876Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:31.876Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:31.876Z] >>> [apiv2][query] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) [none]
[debug] [2025-11-14T13:17:32.010Z] <<< [apiv2][status] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) 200
[debug] [2025-11-14T13:17:32.010Z] <<< [apiv2][body] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) {"name":"projects/credit-castor/databases/(default)","uid":"29ced56d-581f-4c7a-80f3-35b9912f95e8","createTime":"2025-11-11T23:32:12.816385Z","updateTime":"2025-11-11T23:32:12.816385Z","locationId":"eur3","type":"FIRESTORE_NATIVE","concurrencyMode":"PESSIMISTIC","versionRetentionPeriod":"3600s","earliestVersionTime":"2025-11-14T12:17:32.049384Z","appEngineIntegrationMode":"DISABLED","keyPrefix":"e","pointInTimeRecoveryEnablement":"POINT_IN_TIME_RECOVERY_DISABLED","deleteProtectionState":"DELETE_PROTECTION_DISABLED","databaseEdition":"STANDARD","freeTier":true,"realtimeUpdatesMode":"REALTIME_UPDATES_MODE_ENABLED","etag":"ILCjyo/d8ZADMIqS+JCm65AD"}
[info] i  firestore: reading indexes from firestore.indexes.json... 
[info] i  cloud.firestore: checking firestore.rules for compilation errors... 
[debug] [2025-11-14T13:17:32.012Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:32.012Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:32.013Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test [none]
[debug] [2025-11-14T13:17:32.013Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test [omitted]
[debug] [2025-11-14T13:17:32.736Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test 200
[debug] [2025-11-14T13:17:32.737Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test {}
[info] ✔  cloud.firestore: rules file firestore.rules compiled successfully 
[debug] [2025-11-14T13:17:32.739Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:32.740Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:32.742Z] >>> [apiv2][query] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases pageSize=10&pageToken=
[debug] [2025-11-14T13:17:33.460Z] <<< [apiv2][status] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases 200
[debug] [2025-11-14T13:17:33.461Z] <<< [apiv2][body] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases {"releases":[{"name":"projects/credit-castor/releases/cloud.firestore","rulesetName":"projects/credit-castor/rulesets/fa589146-4111-494d-9431-1fad87540144","createTime":"2025-11-11T23:32:19.686496Z","updateTime":"2025-11-14T13:13:19.434349Z"}]}
[debug] [2025-11-14T13:17:33.461Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:33.461Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:33.462Z] >>> [apiv2][query] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/fa589146-4111-494d-9431-1fad87540144 [none]
[debug] [2025-11-14T13:17:34.137Z] <<< [apiv2][status] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/fa589146-4111-494d-9431-1fad87540144 200
[debug] [2025-11-14T13:17:34.137Z] <<< [apiv2][body] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/fa589146-4111-494d-9431-1fad87540144 [omitted]
[info] i  firestore: uploading rules firestore.rules... 
[debug] [2025-11-14T13:17:34.137Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:34.137Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:34.138Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets [none]
[debug] [2025-11-14T13:17:34.138Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets [omitted]
[debug] [2025-11-14T13:17:34.549Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets 200
[debug] [2025-11-14T13:17:34.549Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets {"name":"projects/credit-castor/rulesets/95ba754e-b421-4536-825b-eb661cb7fcf6","source":{"files":[{"content":"rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Users collection - store custom authentication data\n    match /users/{userId} {\n      // Anyone can create a new user (for registration)\n      allow create: if true;\n\n      // Users can only read their own data\n      allow read: if request.auth != null || request.resource.data.email == userId.replace('_', '@').replace('_', '.');\n\n      // Users cannot update/delete (security measure)\n      allow update, delete: if false;\n    }\n\n    // Projects collection - shared project data\n    match /projects/{projectId} {\n      // Allow read if unlocked (we check unlock state in the app)\n      allow read: if true;\n\n      // Helper function to validate TravauxCommuns structure\n      function isValidTravauxCommuns(travauxCommuns) {\n        // enabled must be boolean if present\n        let enabledValid = !exists(travauxCommuns.enabled) || travauxCommuns.enabled is bool;\n        \n        // If items exist, they must be a list\n        // Note: Detailed item structure validation (label, sqm, cascoPricePerSqm, parachevementPricePerSqm, amount)\n        // happens in the application layer. Firestore Security Rules don't support iterating through lists\n        // to validate individual items, so we only validate that items is a list if present.\n        let itemsValid = !exists(travauxCommuns.items) || travauxCommuns.items is list;\n        \n        return enabledValid && itemsValid;\n      }\n\n      // Helper function to validate ProjectParams structure\n      function isValidProjectParams() {\n        // If projectParams doesn't exist, validation passes (for partial updates)\n        return !exists(request.resource.data.projectParams) || \n               ((!exists(request.resource.data.projectParams.maxTotalLots) || \n                 (request.resource.data.projectParams.maxTotalLots is int && \n                  request.resource.data.projectParams.maxTotalLots > 0)) &&\n                (!exists(request.resource.data.projectParams.travauxCommuns) || \n                 isValidTravauxCommuns(request.resource.data.projectParams.travauxCommuns)));\n      }\n\n      // Allow write if lastModifiedBy is set (custom auth system) - must be a non-empty string\n      // OR if Firebase Auth user is authenticated\n      // Also validate projectParams structure if present\n      allow write: if ((exists(request.resource.data.lastModifiedBy) && \n                        request.resource.data.lastModifiedBy is string && \n                        request.resource.data.lastModifiedBy.size() > 0) || \n                       request.auth != null) &&\n                     isValidProjectParams();\n      \n      // TEMPORARY: Debug rule to see what's being sent\n      // This will help diagnose the permission issue\n      // allow write: if true; // DEBUG ONLY - REMOVE AFTER TESTING\n\n      // Participants subcollection - individual participant documents\n      match /participants/{participantId} {\n        // Allow read if unlocked (same as parent project)\n        allow read: if true;\n\n        // Helper function to validate Participant structure\n        function isValidParticipant() {\n          // lotsOwned must be an array if present\n          let lotsOwnedValid = !exists(request.resource.data.lotsOwned) || \n                               request.resource.data.lotsOwned is list;\n          // enabled must be boolean if present\n          let enabledValid = !exists(request.resource.data.enabled) || \n                            request.resource.data.enabled is bool;\n          return lotsOwnedValid && enabledValid;\n        }\n\n        // Allow write if lastModifiedBy is set (custom auth system) - must be a non-empty string\n        // OR if Firebase Auth user is authenticated\n        // Also validate participant structure\n        allow write: if ((exists(request.resource.data.lastModifiedBy) && \n                          request.resource.data.lastModifiedBy is string && \n                          request.resource.data.lastModifiedBy.size() > 0) || \n                         request.auth != null) &&\n                       isValidParticipant();\n      }\n    }\n\n    // Presence collection - for tracking active users\n    match /presence/{sessionId} {\n      allow read, write: if true; // Presence is ephemeral and not sensitive\n    }\n\n    // Edit locks collection - collaborative editing coordination\n    match /editLocks/{projectId} {\n      // Allow anyone to read locks (to check if a project is locked)\n      allow read: if true;\n\n      // Allow anyone to create/update/delete locks\n      // Transaction-based atomicity in the code prevents race conditions\n      allow create, update, delete: if true;\n    }\n  }\n}","name":"firestore.rules"}]},"createTime":"2025-11-14T13:17:34.455439Z","metadata":{"services":["cloud.firestore"]}}
[debug] [2025-11-14T13:17:34.549Z] [rules] created ruleset projects/credit-castor/rulesets/95ba754e-b421-4536-825b-eb661cb7fcf6
[debug] [2025-11-14T13:17:34.549Z] [rules] releasing cloud.firestore/(default) with ruleset projects/credit-castor/rulesets/95ba754e-b421-4536-825b-eb661cb7fcf6
[debug] [2025-11-14T13:17:34.549Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:34.549Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:34.549Z] >>> [apiv2][query] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) [none]
[debug] [2025-11-14T13:17:34.549Z] >>> [apiv2][body] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) {"release":{"name":"projects/credit-castor/releases/cloud.firestore/(default)","rulesetName":"projects/credit-castor/rulesets/95ba754e-b421-4536-825b-eb661cb7fcf6"}}
[debug] [2025-11-14T13:17:35.432Z] <<< [apiv2][status] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) 200
[debug] [2025-11-14T13:17:54.595Z] ----------------------------------------------------------------------
[debug] [2025-11-14T13:17:54.597Z] Command:       /Users/dragan/.nvm/versions/node/v20.19.2/bin/node /Users/dragan/.nvm/versions/node/v20.19.2/bin/firebase deploy --only firestore:rules
[debug] [2025-11-14T13:17:54.597Z] CLI Version:   14.24.2
[debug] [2025-11-14T13:17:54.597Z] Platform:      darwin
[debug] [2025-11-14T13:17:54.597Z] Node Version:  v20.19.2
[debug] [2025-11-14T13:17:54.597Z] Time:          Fri Nov 14 2025 14:17:54 GMT+0100 (Central European Standard Time)
[debug] [2025-11-14T13:17:54.597Z] ----------------------------------------------------------------------
[debug] 
[debug] [2025-11-14T13:17:54.679Z] > command requires scopes: ["email","openid","https://www.googleapis.com/auth/cloudplatformprojects.readonly","https://www.googleapis.com/auth/firebase","https://www.googleapis.com/auth/cloud-platform"]
[debug] [2025-11-14T13:17:54.680Z] > authorizing via signed-in user (drag.markovic@gmail.com)
[debug] [2025-11-14T13:17:54.680Z] [iam] checking project credit-castor for permissions ["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]
[debug] [2025-11-14T13:17:54.680Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:54.681Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:54.681Z] >>> [apiv2][query] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions [none]
[debug] [2025-11-14T13:17:54.681Z] >>> [apiv2][(partial)header] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions x-goog-quota-user=projects/credit-castor
[debug] [2025-11-14T13:17:54.681Z] >>> [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[debug] [2025-11-14T13:17:55.440Z] <<< [apiv2][status] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions 200
[debug] [2025-11-14T13:17:55.440Z] <<< [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[info] 
[info] === Deploying to 'credit-castor'...
[info] 
[info] i  deploying firestore 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[debug] [2025-11-14T13:17:55.443Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:55.443Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:55.443Z] >>> [apiv2][query] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) [none]
[debug] [2025-11-14T13:17:55.551Z] <<< [apiv2][status] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) 200
[debug] [2025-11-14T13:17:55.551Z] <<< [apiv2][body] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) {"name":"projects/credit-castor/databases/(default)","uid":"29ced56d-581f-4c7a-80f3-35b9912f95e8","createTime":"2025-11-11T23:32:12.816385Z","updateTime":"2025-11-11T23:32:12.816385Z","locationId":"eur3","type":"FIRESTORE_NATIVE","concurrencyMode":"PESSIMISTIC","versionRetentionPeriod":"3600s","earliestVersionTime":"2025-11-14T12:17:55.592242Z","appEngineIntegrationMode":"DISABLED","keyPrefix":"e","pointInTimeRecoveryEnablement":"POINT_IN_TIME_RECOVERY_DISABLED","deleteProtectionState":"DELETE_PROTECTION_DISABLED","databaseEdition":"STANDARD","freeTier":true,"realtimeUpdatesMode":"REALTIME_UPDATES_MODE_ENABLED","etag":"IK2c55rd8ZADMIqS+JCm65AD"}
[info] i  firestore: reading indexes from firestore.indexes.json... 
[info] i  cloud.firestore: checking firestore.rules for compilation errors... 
[debug] [2025-11-14T13:17:55.553Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:55.553Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:55.553Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test [none]
[debug] [2025-11-14T13:17:55.553Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test [omitted]
[debug] [2025-11-14T13:17:56.278Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test 200
[debug] [2025-11-14T13:17:56.278Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test {"issues":[{"sourcePosition":{"fileName":"firestore.rules","line":25,"column":29,"currentOffset":898,"endOffset":903},"description":"Invalid function name: exists.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":31,"column":27,"currentOffset":1365,"endOffset":1370},"description":"Invalid function name: exists.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":37,"column":16,"currentOffset":1564,"endOffset":1583},"description":"Unused function: isValidProjectParams.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":39,"column":17,"currentOffset":1688,"endOffset":1693},"description":"Invalid function name: exists.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":39,"column":24,"currentOffset":1695,"endOffset":1701},"description":"Invalid variable name: request.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":40,"column":19,"currentOffset":1754,"endOffset":1759},"description":"Invalid function name: exists.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":40,"column":26,"currentOffset":1761,"endOffset":1767},"description":"Invalid variable name: request.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":41,"column":19,"currentOffset":1833,"endOffset":1839},"description":"Invalid variable name: request.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":42,"column":19,"currentOffset":1911,"endOffset":1917},"description":"Invalid variable name: request.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":43,"column":19,"currentOffset":1987,"endOffset":1992},"description":"Invalid function name: exists.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":43,"column":26,"currentOffset":1994,"endOffset":2000},"description":"Invalid variable name: request.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":44,"column":40,"currentOffset":2089,"endOffset":2095},"description":"Invalid variable name: request.","severity":"WARNING"}]}
[warn] ⚠  [W] 25:29 - Invalid function name: exists. 
[warn] ⚠  [W] 31:27 - Invalid function name: exists. 
[warn] ⚠  [W] 37:16 - Unused function: isValidProjectParams. 
[warn] ⚠  [W] 39:17 - Invalid function name: exists. 
[warn] ⚠  [W] 39:24 - Invalid variable name: request. 
[warn] ⚠  [W] 40:19 - Invalid function name: exists. 
[warn] ⚠  [W] 40:26 - Invalid variable name: request. 
[warn] ⚠  [W] 41:19 - Invalid variable name: request. 
[warn] ⚠  [W] 42:19 - Invalid variable name: request. 
[warn] ⚠  [W] 43:19 - Invalid function name: exists. 
[warn] ⚠  [W] 43:26 - Invalid variable name: request. 
[warn] ⚠  [W] 44:40 - Invalid variable name: request. 
[info] ✔  cloud.firestore: rules file firestore.rules compiled successfully 
[debug] [2025-11-14T13:17:56.281Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:56.281Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:56.282Z] >>> [apiv2][query] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases pageSize=10&pageToken=
[debug] [2025-11-14T13:17:56.970Z] <<< [apiv2][status] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases 200
[debug] [2025-11-14T13:17:56.970Z] <<< [apiv2][body] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases {"releases":[{"name":"projects/credit-castor/releases/cloud.firestore","rulesetName":"projects/credit-castor/rulesets/95ba754e-b421-4536-825b-eb661cb7fcf6","createTime":"2025-11-11T23:32:19.686496Z","updateTime":"2025-11-14T13:17:35.393682Z"}]}
[debug] [2025-11-14T13:17:56.970Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:56.971Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:56.971Z] >>> [apiv2][query] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/95ba754e-b421-4536-825b-eb661cb7fcf6 [none]
[debug] [2025-11-14T13:17:57.634Z] <<< [apiv2][status] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/95ba754e-b421-4536-825b-eb661cb7fcf6 200
[debug] [2025-11-14T13:17:57.634Z] <<< [apiv2][body] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/95ba754e-b421-4536-825b-eb661cb7fcf6 [omitted]
[info] i  firestore: uploading rules firestore.rules... 
[debug] [2025-11-14T13:17:57.635Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:57.635Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:57.635Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets [none]
[debug] [2025-11-14T13:17:57.636Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets [omitted]
[debug] [2025-11-14T13:17:57.997Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets 200
[debug] [2025-11-14T13:17:57.997Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets {"name":"projects/credit-castor/rulesets/77e31b1d-bd9f-4b62-a7d0-83b79d947d5e","source":{"files":[{"content":"rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Users collection - store custom authentication data\n    match /users/{userId} {\n      // Anyone can create a new user (for registration)\n      allow create: if true;\n\n      // Users can only read their own data\n      allow read: if request.auth != null || request.resource.data.email == userId.replace('_', '@').replace('_', '.');\n\n      // Users cannot update/delete (security measure)\n      allow update, delete: if false;\n    }\n\n    // Projects collection - shared project data\n    match /projects/{projectId} {\n      // Allow read if unlocked (we check unlock state in the app)\n      allow read: if true;\n\n      // Helper function to validate TravauxCommuns structure\n      function isValidTravauxCommuns(travauxCommuns) {\n        // enabled must be boolean if present\n        let enabledValid = !exists(travauxCommuns.enabled) || travauxCommuns.enabled is bool;\n        \n        // If items exist, they must be a list\n        // Note: Detailed item structure validation (label, sqm, cascoPricePerSqm, parachevementPricePerSqm, amount)\n        // happens in the application layer. Firestore Security Rules don't support iterating through lists\n        // to validate individual items, so we only validate that items is a list if present.\n        let itemsValid = !exists(travauxCommuns.items) || travauxCommuns.items is list;\n        \n        return enabledValid && itemsValid;\n      }\n\n      // Helper function to validate ProjectParams structure\n      function isValidProjectParams() {\n        // If projectParams doesn't exist, validation passes (for partial updates)\n        return !exists(request.resource.data.projectParams) || \n               ((!exists(request.resource.data.projectParams.maxTotalLots) || \n                 (request.resource.data.projectParams.maxTotalLots is int && \n                  request.resource.data.projectParams.maxTotalLots > 0)) &&\n                (!exists(request.resource.data.projectParams.travauxCommuns) || \n                 isValidTravauxCommuns(request.resource.data.projectParams.travauxCommuns)));\n      }\n\n      // TEMPORARY: Debug rule - allow all writes to test if rules are the issue\n      // TODO: Remove this and restore proper rules after testing\n      allow write: if true;\n      \n      // Original rule (commented out for debugging):\n      // Allow write if lastModifiedBy is set (custom auth system) - must be a non-empty string\n      // OR if Firebase Auth user is authenticated\n      // Also validate projectParams structure if present\n      // allow write: if ((exists(request.resource.data.lastModifiedBy) && \n      //                   request.resource.data.lastModifiedBy is string && \n      //                   request.resource.data.lastModifiedBy.size() > 0) || \n      //                 request.auth != null) &&\n      //               isValidProjectParams();\n\n      // Participants subcollection - individual participant documents\n      match /participants/{participantId} {\n        // Allow read if unlocked (same as parent project)\n        allow read: if true;\n\n        // Helper function to validate Participant structure\n        function isValidParticipant() {\n          // lotsOwned must be an array if present\n          let lotsOwnedValid = !exists(request.resource.data.lotsOwned) || \n                               request.resource.data.lotsOwned is list;\n          // enabled must be boolean if present\n          let enabledValid = !exists(request.resource.data.enabled) || \n                            request.resource.data.enabled is bool;\n          return lotsOwnedValid && enabledValid;\n        }\n\n        // Allow write if lastModifiedBy is set (custom auth system) - must be a non-empty string\n        // OR if Firebase Auth user is authenticated\n        // Also validate participant structure\n        allow write: if ((exists(request.resource.data.lastModifiedBy) && \n                          request.resource.data.lastModifiedBy is string && \n                          request.resource.data.lastModifiedBy.size() > 0) || \n                         request.auth != null) &&\n                       isValidParticipant();\n      }\n    }\n\n    // Presence collection - for tracking active users\n    match /presence/{sessionId} {\n      allow read, write: if true; // Presence is ephemeral and not sensitive\n    }\n\n    // Edit locks collection - collaborative editing coordination\n    match /editLocks/{projectId} {\n      // Allow anyone to read locks (to check if a project is locked)\n      allow read: if true;\n\n      // Allow anyone to create/update/delete locks\n      // Transaction-based atomicity in the code prevents race conditions\n      allow create, update, delete: if true;\n    }\n  }\n}","name":"firestore.rules"}]},"createTime":"2025-11-14T13:17:57.925007Z","metadata":{"services":["cloud.firestore"]}}
[debug] [2025-11-14T13:17:57.997Z] [rules] created ruleset projects/credit-castor/rulesets/77e31b1d-bd9f-4b62-a7d0-83b79d947d5e
[debug] [2025-11-14T13:17:57.998Z] [rules] releasing cloud.firestore/(default) with ruleset projects/credit-castor/rulesets/77e31b1d-bd9f-4b62-a7d0-83b79d947d5e
[debug] [2025-11-14T13:17:57.998Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:57.998Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:57.998Z] >>> [apiv2][query] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) [none]
[debug] [2025-11-14T13:17:57.998Z] >>> [apiv2][body] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) {"release":{"name":"projects/credit-castor/releases/cloud.firestore/(default)","rulesetName":"projects/credit-castor/rulesets/77e31b1d-bd9f-4b62-a7d0-83b79d947d5e"}}
[debug] [2025-11-14T13:17:58.880Z] <<< [apiv2][status] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) 200
[debug] [2025-11-14T13:27:33.330Z] ----------------------------------------------------------------------
[debug] [2025-11-14T13:27:33.331Z] Command:       /Users/dragan/.nvm/versions/node/v20.19.2/bin/node /Users/dragan/.nvm/versions/node/v20.19.2/bin/firebase deploy --only firestore:rules
[debug] [2025-11-14T13:27:33.332Z] CLI Version:   14.24.2
[debug] [2025-11-14T13:27:33.332Z] Platform:      darwin
[debug] [2025-11-14T13:27:33.332Z] Node Version:  v20.19.2
[debug] [2025-11-14T13:27:33.332Z] Time:          Fri Nov 14 2025 14:27:33 GMT+0100 (Central European Standard Time)
[debug] [2025-11-14T13:27:33.332Z] ----------------------------------------------------------------------
[debug] 
[debug] [2025-11-14T13:27:33.417Z] > command requires scopes: ["email","openid","https://www.googleapis.com/auth/cloudplatformprojects.readonly","https://www.googleapis.com/auth/firebase","https://www.googleapis.com/auth/cloud-platform"]
[debug] [2025-11-14T13:27:33.417Z] > authorizing via signed-in user (drag.markovic@gmail.com)
[debug] [2025-11-14T13:27:33.418Z] [iam] checking project credit-castor for permissions ["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]
[debug] [2025-11-14T13:27:33.418Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:27:33.418Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:27:33.418Z] >>> [apiv2][query] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions [none]
[debug] [2025-11-14T13:27:33.418Z] >>> [apiv2][(partial)header] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions x-goog-quota-user=projects/credit-castor
[debug] [2025-11-14T13:27:33.419Z] >>> [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[debug] [2025-11-14T13:27:34.136Z] <<< [apiv2][status] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions 200
[debug] [2025-11-14T13:27:34.136Z] <<< [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[info] 
[info] === Deploying to 'credit-castor'...
[info] 
[info] i  deploying firestore 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[debug] [2025-11-14T13:27:34.140Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:27:34.140Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:27:34.140Z] >>> [apiv2][query] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) [none]
[debug] [2025-11-14T13:27:34.269Z] <<< [apiv2][status] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) 200
[debug] [2025-11-14T13:27:34.269Z] <<< [apiv2][body] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) {"name":"projects/credit-castor/databases/(default)","uid":"29ced56d-581f-4c7a-80f3-35b9912f95e8","createTime":"2025-11-11T23:32:12.816385Z","updateTime":"2025-11-11T23:32:12.816385Z","locationId":"eur3","type":"FIRESTORE_NATIVE","concurrencyMode":"PESSIMISTIC","versionRetentionPeriod":"3600s","earliestVersionTime":"2025-11-14T12:27:34.301954Z","appEngineIntegrationMode":"DISABLED","keyPrefix":"e","pointInTimeRecoveryEnablement":"POINT_IN_TIME_RECOVERY_DISABLED","deleteProtectionState":"DELETE_PROTECTION_DISABLED","databaseEdition":"STANDARD","freeTier":true,"realtimeUpdatesMode":"REALTIME_UPDATES_MODE_ENABLED","etag":"IN3t4K7f8ZADMIqS+JCm65AD"}
[info] i  firestore: reading indexes from firestore.indexes.json... 
[info] i  cloud.firestore: checking firestore.rules for compilation errors... 
[debug] [2025-11-14T13:27:34.272Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:27:34.272Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:27:34.272Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test [none]
[debug] [2025-11-14T13:27:34.272Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test [omitted]
[debug] [2025-11-14T13:27:35.014Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test 200
[debug] [2025-11-14T13:27:35.014Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test {"issues":[{"sourcePosition":{"fileName":"firestore.rules","line":39,"column":9,"currentOffset":1680,"endOffset":1681},"description":"Unexpected 'if'.","severity":"ERROR"},{"sourcePosition":{"fileName":"firestore.rules","line":46,"column":9,"currentOffset":2003,"endOffset":2005},"description":"Unexpected 'let'.","severity":"ERROR"},{"sourcePosition":{"fileName":"firestore.rules","line":55,"column":9,"currentOffset":2501,"endOffset":2503},"description":"Unexpected 'let'.","severity":"ERROR"},{"sourcePosition":{"fileName":"firestore.rules","line":60,"column":9,"currentOffset":2741,"endOffset":2746},"description":"Unexpected 'return'.","severity":"ERROR"},{"sourcePosition":{"fileName":"firestore.rules","line":91,"column":9,"currentOffset":4280,"endOffset":4284},"description":"Unexpected 'allow'.","severity":"ERROR"}]}
[error] 
[error] Error: Compilation errors in firestore.rules:
[E] 39:9 - Unexpected 'if'.
[E] 46:9 - Unexpected 'let'.
[E] 55:9 - Unexpected 'let'.
[E] 60:9 - Unexpected 'return'.
[E] 91:9 - Unexpected 'allow'.
[debug] [2025-11-14T13:27:50.468Z] ----------------------------------------------------------------------
[debug] [2025-11-14T13:27:50.470Z] Command:       /Users/dragan/.nvm/versions/node/v20.19.2/bin/node /Users/dragan/.nvm/versions/node/v20.19.2/bin/firebase deploy --only firestore:rules
[debug] [2025-11-14T13:27:50.470Z] CLI Version:   14.24.2
[debug] [2025-11-14T13:27:50.470Z] Platform:      darwin
[debug] [2025-11-14T13:27:50.470Z] Node Version:  v20.19.2
[debug] [2025-11-14T13:27:50.470Z] Time:          Fri Nov 14 2025 14:27:50 GMT+0100 (Central European Standard Time)
[debug] [2025-11-14T13:27:50.470Z] ----------------------------------------------------------------------
[debug] 
[debug] [2025-11-14T13:27:50.548Z] > command requires scopes: ["email","openid","https://www.googleapis.com/auth/cloudplatformprojects.readonly","https://www.googleapis.com/auth/firebase","https://www.googleapis.com/auth/cloud-platform"]
[debug] [2025-11-14T13:27:50.548Z] > authorizing via signed-in user (drag.markovic@gmail.com)
[debug] [2025-11-14T13:27:50.548Z] [iam] checking project credit-castor for permissions ["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]
[debug] [2025-11-14T13:27:50.549Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:27:50.549Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:27:50.549Z] >>> [apiv2][query] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions [none]
[debug] [2025-11-14T13:27:50.549Z] >>> [apiv2][(partial)header] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions x-goog-quota-user=projects/credit-castor
[debug] [2025-11-14T13:27:50.549Z] >>> [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[debug] [2025-11-14T13:27:51.245Z] <<< [apiv2][status] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions 200
[debug] [2025-11-14T13:27:51.245Z] <<< [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[info] 
[info] === Deploying to 'credit-castor'...
[info] 
[info] i  deploying firestore 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[debug] [2025-11-14T13:27:51.249Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:27:51.249Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:27:51.249Z] >>> [apiv2][query] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) [none]
[debug] [2025-11-14T13:27:51.398Z] <<< [apiv2][status] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) 200
[debug] [2025-11-14T13:27:51.398Z] <<< [apiv2][body] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) {"name":"projects/credit-castor/databases/(default)","uid":"29ced56d-581f-4c7a-80f3-35b9912f95e8","createTime":"2025-11-11T23:32:12.816385Z","updateTime":"2025-11-11T23:32:12.816385Z","locationId":"eur3","type":"FIRESTORE_NATIVE","concurrencyMode":"PESSIMISTIC","versionRetentionPeriod":"3600s","earliestVersionTime":"2025-11-14T12:27:51.431170Z","appEngineIntegrationMode":"DISABLED","keyPrefix":"e","pointInTimeRecoveryEnablement":"POINT_IN_TIME_RECOVERY_DISABLED","deleteProtectionState":"DELETE_PROTECTION_DISABLED","databaseEdition":"STANDARD","freeTier":true,"realtimeUpdatesMode":"REALTIME_UPDATES_MODE_ENABLED","etag":"IM+s9rbf8ZADMIqS+JCm65AD"}
[info] i  firestore: reading indexes from firestore.indexes.json... 
[info] i  cloud.firestore: checking firestore.rules for compilation errors... 
[debug] [2025-11-14T13:27:51.401Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:27:51.401Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:27:51.402Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test [none]
[debug] [2025-11-14T13:27:51.402Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test [omitted]
[debug] [2025-11-14T13:27:51.765Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test 200
[debug] [2025-11-14T13:27:51.766Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test {}
[info] ✔  cloud.firestore: rules file firestore.rules compiled successfully 
[debug] [2025-11-14T13:27:51.768Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:27:51.768Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:27:51.768Z] >>> [apiv2][query] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases pageSize=10&pageToken=
[debug] [2025-11-14T13:27:52.476Z] <<< [apiv2][status] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases 200
[debug] [2025-11-14T13:27:52.477Z] <<< [apiv2][body] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases {"releases":[{"name":"projects/credit-castor/releases/cloud.firestore","rulesetName":"projects/credit-castor/rulesets/77e31b1d-bd9f-4b62-a7d0-83b79d947d5e","createTime":"2025-11-11T23:32:19.686496Z","updateTime":"2025-11-14T13:17:58.832982Z"}]}
[debug] [2025-11-14T13:27:52.477Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:27:52.477Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:27:52.478Z] >>> [apiv2][query] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/77e31b1d-bd9f-4b62-a7d0-83b79d947d5e [none]
[debug] [2025-11-14T13:27:52.773Z] <<< [apiv2][status] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/77e31b1d-bd9f-4b62-a7d0-83b79d947d5e 200
[debug] [2025-11-14T13:27:52.773Z] <<< [apiv2][body] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/77e31b1d-bd9f-4b62-a7d0-83b79d947d5e [omitted]
[info] i  firestore: uploading rules firestore.rules... 
[debug] [2025-11-14T13:27:52.775Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:27:52.775Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:27:52.775Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets [none]
[debug] [2025-11-14T13:27:52.776Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets [omitted]
[debug] [2025-11-14T13:27:53.609Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets 200
[debug] [2025-11-14T13:27:53.610Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets {"name":"projects/credit-castor/rulesets/fe286028-3339-469b-8bd8-d79061f3075e","source":{"files":[{"content":"rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Users collection - store custom authentication data\n    match /users/{userId} {\n      // Anyone can create a new user (for registration)\n      allow create: if true;\n\n      // Users can only read their own data\n      allow read: if request.auth != null || request.resource.data.email == userId.replace('_', '@').replace('_', '.');\n\n      // Users cannot update/delete (security measure)\n      allow update, delete: if false;\n    }\n\n    // Projects collection - shared project data\n    match /projects/{projectId} {\n      // Allow read if unlocked (we check unlock state in the app)\n      allow read: if true;\n\n      // Helper function to validate TravauxCommuns structure\n      function isValidTravauxCommuns(travauxCommuns) {\n        // enabled must be boolean if present\n        let enabledValid = !exists(travauxCommuns.enabled) || travauxCommuns.enabled is bool;\n        \n        // If items exist, they must be a list\n        // Note: Detailed item structure validation (label, sqm, cascoPricePerSqm, parachevementPricePerSqm, amount)\n        // happens in the application layer. Firestore Security Rules don't support iterating through lists\n        // to validate individual items, so we only validate that items is a list if present.\n        let itemsValid = !exists(travauxCommuns.items) || travauxCommuns.items is list;\n        \n        return enabledValid && itemsValid;\n      }\n\n      // Helper function to validate ProjectParams structure\n      function isValidProjectParams() {\n        // If projectParams doesn't exist, validation passes (for partial updates)\n        return !exists(request.resource.data.projectParams) || \n               (\n                 // Validate maxTotalLots if it exists\n                 // When using setDoc with merge: true, existing null values might be preserved\n                 // So we check: if maxTotalLots doesn't exist, it's valid; if it exists, it must be int > 0\n                 // Note: null values will fail the \"is int\" check, which is what we want\n                 (!exists(request.resource.data.projectParams.maxTotalLots) || \n                  (request.resource.data.projectParams.maxTotalLots is int && \n                   request.resource.data.projectParams.maxTotalLots > 0)) &&\n                 // Validate travauxCommuns if it exists\n                 (!exists(request.resource.data.projectParams.travauxCommuns) || \n                  isValidTravauxCommuns(request.resource.data.projectParams.travauxCommuns))\n               );\n      }\n\n      // Allow write if lastModifiedBy is set (custom auth system) - must be a non-empty string\n      // OR if Firebase Auth user is authenticated\n      // Also validate projectParams structure if present\n      allow write: if ((exists(request.resource.data.lastModifiedBy) && \n                        request.resource.data.lastModifiedBy is string && \n                        request.resource.data.lastModifiedBy.size() > 0) || \n                       request.auth != null) &&\n                     isValidProjectParams();\n\n      // Participants subcollection - individual participant documents\n      match /participants/{participantId} {\n        // Allow read if unlocked (same as parent project)\n        allow read: if true;\n\n        // Helper function to validate Participant structure\n        function isValidParticipant() {\n          // lotsOwned must be an array if present\n          let lotsOwnedValid = !exists(request.resource.data.lotsOwned) || \n                               request.resource.data.lotsOwned is list;\n          // enabled must be boolean if present\n          let enabledValid = !exists(request.resource.data.enabled) || \n                            request.resource.data.enabled is bool;\n          return lotsOwnedValid && enabledValid;\n        }\n\n        // Allow write if lastModifiedBy is set (custom auth system) - must be a non-empty string\n        // OR if Firebase Auth user is authenticated\n        // Also validate participant structure\n        allow write: if ((exists(request.resource.data.lastModifiedBy) && \n                          request.resource.data.lastModifiedBy is string && \n                          request.resource.data.lastModifiedBy.size() > 0) || \n                         request.auth != null) &&\n                       isValidParticipant();\n      }\n    }\n\n    // Presence collection - for tracking active users\n    match /presence/{sessionId} {\n      allow read, write: if true; // Presence is ephemeral and not sensitive\n    }\n\n    // Edit locks collection - collaborative editing coordination\n    match /editLocks/{projectId} {\n      // Allow anyone to read locks (to check if a project is locked)\n      allow read: if true;\n\n      // Allow anyone to create/update/delete locks\n      // Transaction-based atomicity in the code prevents race conditions\n      allow create, update, delete: if true;\n    }\n  }\n}","name":"firestore.rules"}]},"createTime":"2025-11-14T13:27:53.564015Z","metadata":{"services":["cloud.firestore"]}}
[debug] [2025-11-14T13:27:53.610Z] [rules] created ruleset projects/credit-castor/rulesets/fe286028-3339-469b-8bd8-d79061f3075e
[debug] [2025-11-14T13:27:53.611Z] [rules] releasing cloud.firestore/(default) with ruleset projects/credit-castor/rulesets/fe286028-3339-469b-8bd8-d79061f3075e
[debug] [2025-11-14T13:27:53.611Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:27:53.611Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:27:53.611Z] >>> [apiv2][query] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) [none]
[debug] [2025-11-14T13:27:53.611Z] >>> [apiv2][body] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) {"release":{"name":"projects/credit-castor/releases/cloud.firestore/(default)","rulesetName":"projects/credit-castor/rulesets/fe286028-3339-469b-8bd8-d79061f3075e"}}
[debug] [2025-11-14T13:27:54.471Z] <<< [apiv2][status] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) 200
[debug] [2025-11-14T13:32:16.532Z] ----------------------------------------------------------------------
[debug] [2025-11-14T13:32:16.534Z] Command:       /Users/dragan/.nvm/versions/node/v20.19.2/bin/node /Users/dragan/.nvm/versions/node/v20.19.2/bin/firebase deploy --only firestore:rules
[debug] [2025-11-14T13:32:16.534Z] CLI Version:   14.24.2
[debug] [2025-11-14T13:32:16.534Z] Platform:      darwin
[debug] [2025-11-14T13:32:16.534Z] Node Version:  v20.19.2
[debug] [2025-11-14T13:32:16.534Z] Time:          Fri Nov 14 2025 14:32:16 GMT+0100 (Central European Standard Time)
[debug] [2025-11-14T13:32:16.534Z] ----------------------------------------------------------------------
[debug] 
[debug] [2025-11-14T13:32:16.622Z] > command requires scopes: ["email","openid","https://www.googleapis.com/auth/cloudplatformprojects.readonly","https://www.googleapis.com/auth/firebase","https://www.googleapis.com/auth/cloud-platform"]
[debug] [2025-11-14T13:32:16.623Z] > authorizing via signed-in user (drag.markovic@gmail.com)
[debug] [2025-11-14T13:32:16.623Z] [iam] checking project credit-castor for permissions ["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]
[debug] [2025-11-14T13:32:16.623Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:32:16.623Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:32:16.624Z] >>> [apiv2][query] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions [none]
[debug] [2025-11-14T13:32:16.624Z] >>> [apiv2][(partial)header] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions x-goog-quota-user=projects/credit-castor
[debug] [2025-11-14T13:32:16.624Z] >>> [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[debug] [2025-11-14T13:32:17.457Z] <<< [apiv2][status] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions 200
[debug] [2025-11-14T13:32:17.458Z] <<< [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[info] 
[info] === Deploying to 'credit-castor'...
[info] 
[info] i  deploying firestore 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[debug] [2025-11-14T13:32:17.461Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:32:17.462Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:32:17.462Z] >>> [apiv2][query] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) [none]
[debug] [2025-11-14T13:32:17.653Z] <<< [apiv2][status] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) 200
[debug] [2025-11-14T13:32:17.653Z] <<< [apiv2][body] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) {"name":"projects/credit-castor/databases/(default)","uid":"29ced56d-581f-4c7a-80f3-35b9912f95e8","createTime":"2025-11-11T23:32:12.816385Z","updateTime":"2025-11-11T23:32:12.816385Z","locationId":"eur3","type":"FIRESTORE_NATIVE","concurrencyMode":"PESSIMISTIC","versionRetentionPeriod":"3600s","earliestVersionTime":"2025-11-14T12:32:17.685977Z","appEngineIntegrationMode":"DISABLED","keyPrefix":"e","pointInTimeRecoveryEnablement":"POINT_IN_TIME_RECOVERY_DISABLED","deleteProtectionState":"DELETE_PROTECTION_DISABLED","databaseEdition":"STANDARD","freeTier":true,"realtimeUpdatesMode":"REALTIME_UPDATES_MODE_ENABLED","etag":"IKCf8bXg8ZADMIqS+JCm65AD"}
[info] i  firestore: reading indexes from firestore.indexes.json... 
[info] i  cloud.firestore: checking firestore.rules for compilation errors... 
[debug] [2025-11-14T13:32:17.655Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:32:17.655Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:32:17.655Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test [none]
[debug] [2025-11-14T13:32:17.655Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test [omitted]
[debug] [2025-11-14T13:32:18.375Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test 200
[debug] [2025-11-14T13:32:18.376Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test {"issues":[{"sourcePosition":{"fileName":"firestore.rules","line":48,"column":18,"currentOffset":2379,"endOffset":2381},"description":"Unexpected 'let'.","severity":"ERROR"},{"sourcePosition":{"fileName":"firestore.rules","line":49,"column":18,"currentOffset":2479,"endOffset":2481},"description":"mismatched input 'let' expecting '}'","severity":"ERROR"},{"sourcePosition":{"fileName":"firestore.rules","line":114,"column":1,"currentOffset":5685,"endOffset":5685},"description":"Unexpected '}'.","severity":"ERROR"}]}
[error] 
[error] Error: Compilation errors in firestore.rules:
[E] 48:18 - Unexpected 'let'.
[E] 49:18 - mismatched input 'let' expecting '}'
[E] 114:1 - Unexpected '}'.
[debug] [2025-11-14T13:32:31.800Z] ----------------------------------------------------------------------
[debug] [2025-11-14T13:32:31.801Z] Command:       /Users/dragan/.nvm/versions/node/v20.19.2/bin/node /Users/dragan/.nvm/versions/node/v20.19.2/bin/firebase deploy --only firestore:rules
[debug] [2025-11-14T13:32:31.802Z] CLI Version:   14.24.2
[debug] [2025-11-14T13:32:31.802Z] Platform:      darwin
[debug] [2025-11-14T13:32:31.802Z] Node Version:  v20.19.2
[debug] [2025-11-14T13:32:31.802Z] Time:          Fri Nov 14 2025 14:32:31 GMT+0100 (Central European Standard Time)
[debug] [2025-11-14T13:32:31.802Z] ----------------------------------------------------------------------
[debug] 
[debug] [2025-11-14T13:32:31.882Z] > command requires scopes: ["email","openid","https://www.googleapis.com/auth/cloudplatformprojects.readonly","https://www.googleapis.com/auth/firebase","https://www.googleapis.com/auth/cloud-platform"]
[debug] [2025-11-14T13:32:31.883Z] > authorizing via signed-in user (drag.markovic@gmail.com)
[debug] [2025-11-14T13:32:31.883Z] [iam] checking project credit-castor for permissions ["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]
[debug] [2025-11-14T13:32:31.883Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:32:31.883Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:32:31.884Z] >>> [apiv2][query] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions [none]
[debug] [2025-11-14T13:32:31.884Z] >>> [apiv2][(partial)header] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions x-goog-quota-user=projects/credit-castor
[debug] [2025-11-14T13:32:31.884Z] >>> [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[debug] [2025-11-14T13:32:32.617Z] <<< [apiv2][status] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions 200
[debug] [2025-11-14T13:32:32.618Z] <<< [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[info] 
[info] === Deploying to 'credit-castor'...
[info] 
[info] i  deploying firestore 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[debug] [2025-11-14T13:32:32.620Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:32:32.620Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:32:32.620Z] >>> [apiv2][query] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) [none]
[debug] [2025-11-14T13:32:32.741Z] <<< [apiv2][status] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) 200
[debug] [2025-11-14T13:32:32.741Z] <<< [apiv2][body] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) {"name":"projects/credit-castor/databases/(default)","uid":"29ced56d-581f-4c7a-80f3-35b9912f95e8","createTime":"2025-11-11T23:32:12.816385Z","updateTime":"2025-11-11T23:32:12.816385Z","locationId":"eur3","type":"FIRESTORE_NATIVE","concurrencyMode":"PESSIMISTIC","versionRetentionPeriod":"3600s","earliestVersionTime":"2025-11-14T12:32:32.771332Z","appEngineIntegrationMode":"DISABLED","keyPrefix":"e","pointInTimeRecoveryEnablement":"POINT_IN_TIME_RECOVERY_DISABLED","deleteProtectionState":"DELETE_PROTECTION_DISABLED","databaseEdition":"STANDARD","freeTier":true,"realtimeUpdatesMode":"REALTIME_UPDATES_MODE_ENABLED","etag":"IPL9ib3g8ZADMIqS+JCm65AD"}
[info] i  firestore: reading indexes from firestore.indexes.json... 
[info] i  cloud.firestore: checking firestore.rules for compilation errors... 
[debug] [2025-11-14T13:32:32.745Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:32:32.745Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:32:32.745Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test [none]
[debug] [2025-11-14T13:32:32.745Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test [omitted]
[debug] [2025-11-14T13:32:33.091Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test 200
[debug] [2025-11-14T13:32:33.092Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test {}
[info] ✔  cloud.firestore: rules file firestore.rules compiled successfully 
[debug] [2025-11-14T13:32:33.095Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:32:33.095Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:32:33.096Z] >>> [apiv2][query] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases pageSize=10&pageToken=
[debug] [2025-11-14T13:32:33.778Z] <<< [apiv2][status] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases 200
[debug] [2025-11-14T13:32:33.779Z] <<< [apiv2][body] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases {"releases":[{"name":"projects/credit-castor/releases/cloud.firestore","rulesetName":"projects/credit-castor/rulesets/fe286028-3339-469b-8bd8-d79061f3075e","createTime":"2025-11-11T23:32:19.686496Z","updateTime":"2025-11-14T13:27:54.430164Z"}]}
[debug] [2025-11-14T13:32:33.779Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:32:33.779Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:32:33.780Z] >>> [apiv2][query] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/fe286028-3339-469b-8bd8-d79061f3075e [none]
[debug] [2025-11-14T13:32:34.448Z] <<< [apiv2][status] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/fe286028-3339-469b-8bd8-d79061f3075e 200
[debug] [2025-11-14T13:32:34.448Z] <<< [apiv2][body] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/fe286028-3339-469b-8bd8-d79061f3075e [omitted]
[info] i  firestore: uploading rules firestore.rules... 
[debug] [2025-11-14T13:32:34.450Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:32:34.450Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:32:34.450Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets [none]
[debug] [2025-11-14T13:32:34.450Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets [omitted]
[debug] [2025-11-14T13:32:35.475Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets 200
[debug] [2025-11-14T13:32:35.475Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets {"name":"projects/credit-castor/rulesets/23c92b3c-412a-4015-b9cd-b62e902ce583","source":{"files":[{"content":"rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Users collection - store custom authentication data\n    match /users/{userId} {\n      // Anyone can create a new user (for registration)\n      allow create: if true;\n\n      // Users can only read their own data\n      allow read: if request.auth != null || request.resource.data.email == userId.replace('_', '@').replace('_', '.');\n\n      // Users cannot update/delete (security measure)\n      allow update, delete: if false;\n    }\n\n    // Projects collection - shared project data\n    match /projects/{projectId} {\n      // Allow read if unlocked (we check unlock state in the app)\n      allow read: if true;\n\n      // Helper function to validate TravauxCommuns structure\n      function isValidTravauxCommuns(travauxCommuns) {\n        // enabled must be boolean if present\n        let enabledValid = !exists(travauxCommuns.enabled) || travauxCommuns.enabled is bool;\n        \n        // If items exist, they must be a list\n        // Note: Detailed item structure validation (label, sqm, cascoPricePerSqm, parachevementPricePerSqm, amount)\n        // happens in the application layer. Firestore Security Rules don't support iterating through lists\n        // to validate individual items, so we only validate that items is a list if present.\n        let itemsValid = !exists(travauxCommuns.items) || travauxCommuns.items is list;\n        \n        return enabledValid && itemsValid;\n      }\n\n      // Helper function to validate ProjectParams structure\n      // IMPORTANT: These rules must handle null/undefined/invalid values gracefully\n      // to prevent deployment order issues (rules deployed before UI updates)\n      function isValidProjectParams() {\n        // If projectParams doesn't exist, validation passes (for partial updates)\n        return !exists(request.resource.data.projectParams) || \n               (\n                 // Validate maxTotalLots if it exists\n                 // DEFENSIVE: Handle null, undefined, and invalid values gracefully\n                 // This prevents permission errors when rules are deployed before UI updates\n                 // Strategy: If maxTotalLots exists and is invalid (null, 0, or not int), treat it as missing\n                 // This allows the write to succeed, and the UI code will clean it up on next save\n                 // Allow if: doesn't exist, is null (will be cleaned by UI), or is valid int > 0\n                 (!exists(request.resource.data.projectParams.maxTotalLots) || \n                  request.resource.data.projectParams.maxTotalLots == null || \n                  (request.resource.data.projectParams.maxTotalLots is int && \n                   request.resource.data.projectParams.maxTotalLots > 0)) &&\n                 // Validate travauxCommuns if it exists\n                 (!exists(request.resource.data.projectParams.travauxCommuns) || \n                  isValidTravauxCommuns(request.resource.data.projectParams.travauxCommuns))\n               );\n      }\n\n      // Allow write if lastModifiedBy is set (custom auth system) - must be a non-empty string\n      // OR if Firebase Auth user is authenticated\n      // Also validate projectParams structure if present\n      allow write: if ((exists(request.resource.data.lastModifiedBy) && \n                        request.resource.data.lastModifiedBy is string && \n                        request.resource.data.lastModifiedBy.size() > 0) || \n                       request.auth != null) &&\n                     isValidProjectParams();\n\n      // Participants subcollection - individual participant documents\n      match /participants/{participantId} {\n        // Allow read if unlocked (same as parent project)\n        allow read: if true;\n\n        // Helper function to validate Participant structure\n        function isValidParticipant() {\n          // lotsOwned must be an array if present\n          let lotsOwnedValid = !exists(request.resource.data.lotsOwned) || \n                               request.resource.data.lotsOwned is list;\n          // enabled must be boolean if present\n          let enabledValid = !exists(request.resource.data.enabled) || \n                            request.resource.data.enabled is bool;\n          return lotsOwnedValid && enabledValid;\n        }\n\n        // Allow write if lastModifiedBy is set (custom auth system) - must be a non-empty string\n        // OR if Firebase Auth user is authenticated\n        // Also validate participant structure\n        allow write: if ((exists(request.resource.data.lastModifiedBy) && \n                          request.resource.data.lastModifiedBy is string && \n                          request.resource.data.lastModifiedBy.size() > 0) || \n                         request.auth != null) &&\n                       isValidParticipant();\n      }\n    }\n\n    // Presence collection - for tracking active users\n    match /presence/{sessionId} {\n      allow read, write: if true; // Presence is ephemeral and not sensitive\n    }\n\n    // Edit locks collection - collaborative editing coordination\n    match /editLocks/{projectId} {\n      // Allow anyone to read locks (to check if a project is locked)\n      allow read: if true;\n\n      // Allow anyone to create/update/delete locks\n      // Transaction-based atomicity in the code prevents race conditions\n      allow create, update, delete: if true;\n    }\n  }\n}","name":"firestore.rules"}]},"createTime":"2025-11-14T13:32:35.234095Z","metadata":{"services":["cloud.firestore"]}}
[debug] [2025-11-14T13:32:35.475Z] [rules] created ruleset projects/credit-castor/rulesets/23c92b3c-412a-4015-b9cd-b62e902ce583
[debug] [2025-11-14T13:32:35.476Z] [rules] releasing cloud.firestore/(default) with ruleset projects/credit-castor/rulesets/23c92b3c-412a-4015-b9cd-b62e902ce583
[debug] [2025-11-14T13:32:35.476Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:32:35.476Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:32:35.476Z] >>> [apiv2][query] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) [none]
[debug] [2025-11-14T13:32:35.476Z] >>> [apiv2][body] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) {"release":{"name":"projects/credit-castor/releases/cloud.firestore/(default)","rulesetName":"projects/credit-castor/rulesets/23c92b3c-412a-4015-b9cd-b62e902ce583"}}
[debug] [2025-11-14T13:32:36.348Z] <<< [apiv2][status] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) 200
[debug] [2025-11-14T13:33:03.090Z] ----------------------------------------------------------------------
[debug] [2025-11-14T13:33:03.091Z] Command:       /Users/dragan/.nvm/versions/node/v20.19.2/bin/node /Users/dragan/.nvm/versions/node/v20.19.2/bin/firebase deploy --only firestore:rules
[debug] [2025-11-14T13:33:03.091Z] CLI Version:   14.24.2
[debug] [2025-11-14T13:33:03.091Z] Platform:      darwin
[debug] [2025-11-14T13:33:03.091Z] Node Version:  v20.19.2
[debug] [2025-11-14T13:33:03.091Z] Time:          Fri Nov 14 2025 14:33:03 GMT+0100 (Central European Standard Time)
[debug] [2025-11-14T13:33:03.091Z] ----------------------------------------------------------------------
[debug] 
[debug] [2025-11-14T13:33:03.175Z] > command requires scopes: ["email","openid","https://www.googleapis.com/auth/cloudplatformprojects.readonly","https://www.googleapis.com/auth/firebase","https://www.googleapis.com/auth/cloud-platform"]
[debug] [2025-11-14T13:33:03.175Z] > authorizing via signed-in user (drag.markovic@gmail.com)
[debug] [2025-11-14T13:33:03.175Z] [iam] checking project credit-castor for permissions ["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]
[debug] [2025-11-14T13:33:03.176Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:33:03.176Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:33:03.176Z] >>> [apiv2][query] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions [none]
[debug] [2025-11-14T13:33:03.176Z] >>> [apiv2][(partial)header] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions x-goog-quota-user=projects/credit-castor
[debug] [2025-11-14T13:33:03.176Z] >>> [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[debug] [2025-11-14T13:33:03.864Z] <<< [apiv2][status] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions 200
[debug] [2025-11-14T13:33:03.864Z] <<< [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[info] 
[info] === Deploying to 'credit-castor'...
[info] 
[info] i  deploying firestore 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[debug] [2025-11-14T13:33:03.867Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:33:03.867Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:33:03.867Z] >>> [apiv2][query] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) [none]
[debug] [2025-11-14T13:33:03.982Z] <<< [apiv2][status] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) 200
[debug] [2025-11-14T13:33:03.983Z] <<< [apiv2][body] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) {"name":"projects/credit-castor/databases/(default)","uid":"29ced56d-581f-4c7a-80f3-35b9912f95e8","createTime":"2025-11-11T23:32:12.816385Z","updateTime":"2025-11-11T23:32:12.816385Z","locationId":"eur3","type":"FIRESTORE_NATIVE","concurrencyMode":"PESSIMISTIC","versionRetentionPeriod":"3600s","earliestVersionTime":"2025-11-14T12:33:04.013635Z","appEngineIntegrationMode":"DISABLED","keyPrefix":"e","pointInTimeRecoveryEnablement":"POINT_IN_TIME_RECOVERY_DISABLED","deleteProtectionState":"DELETE_PROTECTION_DISABLED","databaseEdition":"STANDARD","freeTier":true,"realtimeUpdatesMode":"REALTIME_UPDATES_MODE_ENABLED","etag":"IPzr/Mvg8ZADMIqS+JCm65AD"}
[info] i  firestore: reading indexes from firestore.indexes.json... 
[info] i  cloud.firestore: checking firestore.rules for compilation errors... 
[debug] [2025-11-14T13:33:03.984Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:33:03.984Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:33:03.985Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test [none]
[debug] [2025-11-14T13:33:03.985Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test [omitted]
[debug] [2025-11-14T13:33:04.757Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test 200
[debug] [2025-11-14T13:33:04.757Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test {}
[info] ✔  cloud.firestore: rules file firestore.rules compiled successfully 
[debug] [2025-11-14T13:33:04.758Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:33:04.758Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:33:04.759Z] >>> [apiv2][query] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases pageSize=10&pageToken=
[debug] [2025-11-14T13:33:05.051Z] <<< [apiv2][status] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases 200
[debug] [2025-11-14T13:33:05.052Z] <<< [apiv2][body] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases {"releases":[{"name":"projects/credit-castor/releases/cloud.firestore","rulesetName":"projects/credit-castor/rulesets/23c92b3c-412a-4015-b9cd-b62e902ce583","createTime":"2025-11-11T23:32:19.686496Z","updateTime":"2025-11-14T13:32:36.299143Z"}]}
[debug] [2025-11-14T13:33:05.053Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:33:05.053Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:33:05.053Z] >>> [apiv2][query] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/23c92b3c-412a-4015-b9cd-b62e902ce583 [none]
[debug] [2025-11-14T13:33:05.768Z] <<< [apiv2][status] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/23c92b3c-412a-4015-b9cd-b62e902ce583 200
[debug] [2025-11-14T13:33:05.768Z] <<< [apiv2][body] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/23c92b3c-412a-4015-b9cd-b62e902ce583 [omitted]
[info] i  firestore: uploading rules firestore.rules... 
[debug] [2025-11-14T13:33:05.770Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:33:05.770Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:33:05.770Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets [none]
[debug] [2025-11-14T13:33:05.770Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets [omitted]
[debug] [2025-11-14T13:33:06.197Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets 200
[debug] [2025-11-14T13:33:06.197Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets {"name":"projects/credit-castor/rulesets/25221ff3-5c7e-422b-b4b4-f88046862594","source":{"files":[{"content":"rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Users collection - store custom authentication data\n    match /users/{userId} {\n      // Anyone can create a new user (for registration)\n      allow create: if true;\n\n      // Users can only read their own data\n      allow read: if request.auth != null || request.resource.data.email == userId.replace('_', '@').replace('_', '.');\n\n      // Users cannot update/delete (security measure)\n      allow update, delete: if false;\n    }\n\n    // Projects collection - shared project data\n    match /projects/{projectId} {\n      // Allow read if unlocked (we check unlock state in the app)\n      allow read: if true;\n\n      // Helper function to validate TravauxCommuns structure\n      function isValidTravauxCommuns(travauxCommuns) {\n        // enabled must be boolean if present\n        let enabledValid = !exists(travauxCommuns.enabled) || travauxCommuns.enabled is bool;\n        \n        // If items exist, they must be a list\n        // Note: Detailed item structure validation (label, sqm, cascoPricePerSqm, parachevementPricePerSqm, amount)\n        // happens in the application layer. Firestore Security Rules don't support iterating through lists\n        // to validate individual items, so we only validate that items is a list if present.\n        let itemsValid = !exists(travauxCommuns.items) || travauxCommuns.items is list;\n        \n        return enabledValid && itemsValid;\n      }\n\n      // Helper function to validate ProjectParams structure\n      // IMPORTANT: These rules must handle null/undefined/invalid values gracefully\n      // to prevent deployment order issues (rules deployed before UI updates)\n      // \n      // DEPLOYMENT ORDER BEST PRACTICE:\n      // When adding new validated fields, follow this pattern:\n      // 1. Allow null values temporarily (so writes don't fail during transition)\n      // 2. UI code should clean up null/invalid values on next save\n      // 3. After UI is deployed, rules can be tightened if needed\n      //\n      // This pattern prevents permission errors when:\n      // - Rules are deployed before UI updates\n      // - Old UI versions send invalid data\n      // - Users have stale data with invalid values\n      function isValidProjectParams() {\n        // If projectParams doesn't exist, validation passes (for partial updates)\n        return !exists(request.resource.data.projectParams) || \n               (\n                 // Validate maxTotalLots if it exists\n                 // DEFENSIVE: Handle null, undefined, and invalid values gracefully\n                 // This prevents permission errors when rules are deployed before UI updates\n                 // Strategy: Allow null values (UI will clean them up), but reject 0 and invalid types\n                 // Allow if: doesn't exist, is null (will be cleaned by UI), or is valid int > 0\n                 (!exists(request.resource.data.projectParams.maxTotalLots) || \n                  request.resource.data.projectParams.maxTotalLots == null || \n                  (request.resource.data.projectParams.maxTotalLots is int && \n                   request.resource.data.projectParams.maxTotalLots > 0)) &&\n                 // Validate travauxCommuns if it exists\n                 (!exists(request.resource.data.projectParams.travauxCommuns) || \n                  isValidTravauxCommuns(request.resource.data.projectParams.travauxCommuns))\n               );\n      }\n\n      // Allow write if lastModifiedBy is set (custom auth system) - must be a non-empty string\n      // OR if Firebase Auth user is authenticated\n      // Also validate projectParams structure if present\n      allow write: if ((exists(request.resource.data.lastModifiedBy) && \n                        request.resource.data.lastModifiedBy is string && \n                        request.resource.data.lastModifiedBy.size() > 0) || \n                       request.auth != null) &&\n                     isValidProjectParams();\n\n      // Participants subcollection - individual participant documents\n      match /participants/{participantId} {\n        // Allow read if unlocked (same as parent project)\n        allow read: if true;\n\n        // Helper function to validate Participant structure\n        function isValidParticipant() {\n          // lotsOwned must be an array if present\n          let lotsOwnedValid = !exists(request.resource.data.lotsOwned) || \n                               request.resource.data.lotsOwned is list;\n          // enabled must be boolean if present\n          let enabledValid = !exists(request.resource.data.enabled) || \n                            request.resource.data.enabled is bool;\n          return lotsOwnedValid && enabledValid;\n        }\n\n        // Allow write if lastModifiedBy is set (custom auth system) - must be a non-empty string\n        // OR if Firebase Auth user is authenticated\n        // Also validate participant structure\n        allow write: if ((exists(request.resource.data.lastModifiedBy) && \n                          request.resource.data.lastModifiedBy is string && \n                          request.resource.data.lastModifiedBy.size() > 0) || \n                         request.auth != null) &&\n                       isValidParticipant();\n      }\n    }\n\n    // Presence collection - for tracking active users\n    match /presence/{sessionId} {\n      allow read, write: if true; // Presence is ephemeral and not sensitive\n    }\n\n    // Edit locks collection - collaborative editing coordination\n    match /editLocks/{projectId} {\n      // Allow anyone to read locks (to check if a project is locked)\n      allow read: if true;\n\n      // Allow anyone to create/update/delete locks\n      // Transaction-based atomicity in the code prevents race conditions\n      allow create, update, delete: if true;\n    }\n  }\n}","name":"firestore.rules"}]},"createTime":"2025-11-14T13:33:06.150623Z","metadata":{"services":["cloud.firestore"]}}
[debug] [2025-11-14T13:33:06.197Z] [rules] created ruleset projects/credit-castor/rulesets/25221ff3-5c7e-422b-b4b4-f88046862594
[debug] [2025-11-14T13:33:06.198Z] [rules] releasing cloud.firestore/(default) with ruleset projects/credit-castor/rulesets/25221ff3-5c7e-422b-b4b4-f88046862594
[debug] [2025-11-14T13:33:06.198Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:33:06.198Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:33:06.198Z] >>> [apiv2][query] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) [none]
[debug] [2025-11-14T13:33:06.198Z] >>> [apiv2][body] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) {"release":{"name":"projects/credit-castor/releases/cloud.firestore/(default)","rulesetName":"projects/credit-castor/rulesets/25221ff3-5c7e-422b-b4b4-f88046862594"}}
[debug] [2025-11-14T13:33:07.090Z] <<< [apiv2][status] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) 200
[debug] [2025-11-14T13:49:28.352Z] ----------------------------------------------------------------------
[debug] [2025-11-14T13:49:28.353Z] Command:       /Users/dragan/.nvm/versions/node/v20.19.2/bin/node /Users/dragan/.nvm/versions/node/v20.19.2/bin/firebase deploy --only firestore:rules
[debug] [2025-11-14T13:49:28.353Z] CLI Version:   14.24.2
[debug] [2025-11-14T13:49:28.354Z] Platform:      darwin
[debug] [2025-11-14T13:49:28.354Z] Node Version:  v20.19.2
[debug] [2025-11-14T13:49:28.354Z] Time:          Fri Nov 14 2025 14:49:28 GMT+0100 (Central European Standard Time)
[debug] [2025-11-14T13:49:28.354Z] ----------------------------------------------------------------------
[debug] 
[debug] [2025-11-14T13:49:28.435Z] > command requires scopes: ["email","openid","https://www.googleapis.com/auth/cloudplatformprojects.readonly","https://www.googleapis.com/auth/firebase","https://www.googleapis.com/auth/cloud-platform"]
[debug] [2025-11-14T13:49:28.436Z] > authorizing via signed-in user (drag.markovic@gmail.com)
[debug] [2025-11-14T13:49:28.436Z] [iam] checking project credit-castor for permissions ["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]
[debug] [2025-11-14T13:49:28.436Z] Checked if tokens are valid: false, expires at: 1763128583975
[debug] [2025-11-14T13:49:28.437Z] Checked if tokens are valid: false, expires at: 1763128583975
[debug] [2025-11-14T13:49:28.437Z] > refreshing access token with scopes: []
[debug] [2025-11-14T13:49:28.437Z] >>> [apiv2][query] POST https://www.googleapis.com/oauth2/v3/token [none]
[debug] [2025-11-14T13:49:28.437Z] >>> [apiv2][body] POST https://www.googleapis.com/oauth2/v3/token [omitted]
[debug] [2025-11-14T13:49:28.555Z] <<< [apiv2][status] POST https://www.googleapis.com/oauth2/v3/token 200
[debug] [2025-11-14T13:49:28.555Z] <<< [apiv2][body] POST https://www.googleapis.com/oauth2/v3/token [omitted]
[debug] [2025-11-14T13:49:28.566Z] >>> [apiv2][query] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions [none]
[debug] [2025-11-14T13:49:28.566Z] >>> [apiv2][(partial)header] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions x-goog-quota-user=projects/credit-castor
[debug] [2025-11-14T13:49:28.566Z] >>> [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[debug] [2025-11-14T13:49:29.287Z] <<< [apiv2][status] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions 200
[debug] [2025-11-14T13:49:29.288Z] <<< [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[info] 
[info] === Deploying to 'credit-castor'...
[info] 
[info] i  deploying firestore 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[debug] [2025-11-14T13:49:29.291Z] Checked if tokens are valid: true, expires at: 1763131767555
[debug] [2025-11-14T13:49:29.291Z] Checked if tokens are valid: true, expires at: 1763131767555
[debug] [2025-11-14T13:49:29.291Z] >>> [apiv2][query] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) [none]
[debug] [2025-11-14T13:49:29.436Z] <<< [apiv2][status] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) 200
[debug] [2025-11-14T13:49:29.436Z] <<< [apiv2][body] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) {"name":"projects/credit-castor/databases/(default)","uid":"29ced56d-581f-4c7a-80f3-35b9912f95e8","createTime":"2025-11-11T23:32:12.816385Z","updateTime":"2025-11-11T23:32:12.816385Z","locationId":"eur3","type":"FIRESTORE_NATIVE","concurrencyMode":"PESSIMISTIC","versionRetentionPeriod":"3600s","earliestVersionTime":"2025-11-14T12:49:29.419743Z","appEngineIntegrationMode":"DISABLED","keyPrefix":"e","pointInTimeRecoveryEnablement":"POINT_IN_TIME_RECOVERY_DISABLED","deleteProtectionState":"DELETE_PROTECTION_DISABLED","databaseEdition":"STANDARD","freeTier":true,"realtimeUpdatesMode":"REALTIME_UPDATES_MODE_ENABLED","etag":"INGf7aHk8ZADMIqS+JCm65AD"}
[info] i  firestore: reading indexes from firestore.indexes.json... 
[info] i  cloud.firestore: checking firestore.rules for compilation errors... 
[debug] [2025-11-14T13:49:29.439Z] Checked if tokens are valid: true, expires at: 1763131767555
[debug] [2025-11-14T13:49:29.439Z] Checked if tokens are valid: true, expires at: 1763131767555
[debug] [2025-11-14T13:49:29.439Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test [none]
[debug] [2025-11-14T13:49:29.439Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test [omitted]
[debug] [2025-11-14T13:49:30.215Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test 200
[debug] [2025-11-14T13:49:30.215Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test {"issues":[{"sourcePosition":{"fileName":"firestore.rules","line":52,"column":9,"currentOffset":2388,"endOffset":2389},"description":"Unexpected 'if'.","severity":"ERROR"},{"sourcePosition":{"fileName":"firestore.rules","line":61,"column":9,"currentOffset":2881,"endOffset":2883},"description":"Unexpected 'let'.","severity":"ERROR"},{"sourcePosition":{"fileName":"firestore.rules","line":71,"column":9,"currentOffset":3428,"endOffset":3430},"description":"Unexpected 'let'.","severity":"ERROR"},{"sourcePosition":{"fileName":"firestore.rules","line":76,"column":9,"currentOffset":3668,"endOffset":3673},"description":"Unexpected 'return'.","severity":"ERROR"},{"sourcePosition":{"fileName":"firestore.rules","line":107,"column":9,"currentOffset":5207,"endOffset":5211},"description":"Unexpected 'allow'.","severity":"ERROR"}]}
[error] 
[error] Error: Compilation errors in firestore.rules:
[E] 52:9 - Unexpected 'if'.
[E] 61:9 - Unexpected 'let'.
[E] 71:9 - Unexpected 'let'.
[E] 76:9 - Unexpected 'return'.
[E] 107:9 - Unexpected 'allow'.
[debug] [2025-11-14T13:50:32.595Z] ----------------------------------------------------------------------
[debug] [2025-11-14T13:50:32.596Z] Command:       /Users/dragan/.nvm/versions/node/v20.19.2/bin/node /Users/dragan/.nvm/versions/node/v20.19.2/bin/firebase deploy --only firestore:rules
[debug] [2025-11-14T13:50:32.596Z] CLI Version:   14.24.2
[debug] [2025-11-14T13:50:32.596Z] Platform:      darwin
[debug] [2025-11-14T13:50:32.596Z] Node Version:  v20.19.2
[debug] [2025-11-14T13:50:32.596Z] Time:          Fri Nov 14 2025 14:50:32 GMT+0100 (Central European Standard Time)
[debug] [2025-11-14T13:50:32.596Z] ----------------------------------------------------------------------
[debug] 
[debug] [2025-11-14T13:50:32.676Z] > command requires scopes: ["email","openid","https://www.googleapis.com/auth/cloudplatformprojects.readonly","https://www.googleapis.com/auth/firebase","https://www.googleapis.com/auth/cloud-platform"]
[debug] [2025-11-14T13:50:32.676Z] > authorizing via signed-in user (drag.markovic@gmail.com)
[debug] [2025-11-14T13:50:32.677Z] [iam] checking project credit-castor for permissions ["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]
[debug] [2025-11-14T13:50:32.677Z] Checked if tokens are valid: true, expires at: 1763131767555
[debug] [2025-11-14T13:50:32.677Z] Checked if tokens are valid: true, expires at: 1763131767555
[debug] [2025-11-14T13:50:32.677Z] >>> [apiv2][query] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions [none]
[debug] [2025-11-14T13:50:32.678Z] >>> [apiv2][(partial)header] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions x-goog-quota-user=projects/credit-castor
[debug] [2025-11-14T13:50:32.678Z] >>> [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[debug] [2025-11-14T13:50:33.400Z] <<< [apiv2][status] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions 200
[debug] [2025-11-14T13:50:33.401Z] <<< [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[info] 
[info] === Deploying to 'credit-castor'...
[info] 
[info] i  deploying firestore 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[debug] [2025-11-14T13:50:33.404Z] Checked if tokens are valid: true, expires at: 1763131767555
[debug] [2025-11-14T13:50:33.404Z] Checked if tokens are valid: true, expires at: 1763131767555
[debug] [2025-11-14T13:50:33.404Z] >>> [apiv2][query] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) [none]
[debug] [2025-11-14T13:50:33.540Z] <<< [apiv2][status] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) 200
[debug] [2025-11-14T13:50:33.541Z] <<< [apiv2][body] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) {"name":"projects/credit-castor/databases/(default)","uid":"29ced56d-581f-4c7a-80f3-35b9912f95e8","createTime":"2025-11-11T23:32:12.816385Z","updateTime":"2025-11-11T23:32:12.816385Z","locationId":"eur3","type":"FIRESTORE_NATIVE","concurrencyMode":"PESSIMISTIC","versionRetentionPeriod":"3600s","earliestVersionTime":"2025-11-14T12:50:33.521291Z","appEngineIntegrationMode":"DISABLED","keyPrefix":"e","pointInTimeRecoveryEnablement":"POINT_IN_TIME_RECOVERY_DISABLED","deleteProtectionState":"DELETE_PROTECTION_DISABLED","databaseEdition":"STANDARD","freeTier":true,"realtimeUpdatesMode":"REALTIME_UPDATES_MODE_ENABLED","etag":"IPXXtcDk8ZADMIqS+JCm65AD"}
[info] i  firestore: reading indexes from firestore.indexes.json... 
[info] i  cloud.firestore: checking firestore.rules for compilation errors... 
[debug] [2025-11-14T13:50:33.543Z] Checked if tokens are valid: true, expires at: 1763131767555
[debug] [2025-11-14T13:50:33.543Z] Checked if tokens are valid: true, expires at: 1763131767555
[debug] [2025-11-14T13:50:33.543Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test [none]
[debug] [2025-11-14T13:50:33.543Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test [omitted]
[debug] [2025-11-14T13:50:34.297Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test 200
[debug] [2025-11-14T13:50:34.298Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test {}
[info] ✔  cloud.firestore: rules file firestore.rules compiled successfully 
[debug] [2025-11-14T13:50:34.300Z] Checked if tokens are valid: true, expires at: 1763131767555
[debug] [2025-11-14T13:50:34.300Z] Checked if tokens are valid: true, expires at: 1763131767555
[debug] [2025-11-14T13:50:34.300Z] >>> [apiv2][query] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases pageSize=10&pageToken=
[debug] [2025-11-14T13:50:34.469Z] <<< [apiv2][status] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases 200
[debug] [2025-11-14T13:50:34.470Z] <<< [apiv2][body] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases {"releases":[{"name":"projects/credit-castor/releases/cloud.firestore","rulesetName":"projects/credit-castor/rulesets/25221ff3-5c7e-422b-b4b4-f88046862594","createTime":"2025-11-11T23:32:19.686496Z","updateTime":"2025-11-14T13:33:07.047106Z"}]}
[debug] [2025-11-14T13:50:34.471Z] Checked if tokens are valid: true, expires at: 1763131767555
[debug] [2025-11-14T13:50:34.471Z] Checked if tokens are valid: true, expires at: 1763131767555
[debug] [2025-11-14T13:50:34.471Z] >>> [apiv2][query] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/25221ff3-5c7e-422b-b4b4-f88046862594 [none]
[debug] [2025-11-14T13:50:34.660Z] <<< [apiv2][status] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/25221ff3-5c7e-422b-b4b4-f88046862594 200
[debug] [2025-11-14T13:50:34.661Z] <<< [apiv2][body] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/25221ff3-5c7e-422b-b4b4-f88046862594 [omitted]
[info] i  firestore: latest version of firestore.rules already up to date, skipping upload... 
[debug] [2025-11-14T13:50:34.662Z] [rules] releasing cloud.firestore/(default) with ruleset projects/credit-castor/rulesets/25221ff3-5c7e-422b-b4b4-f88046862594
[debug] [2025-11-14T13:50:34.662Z] Checked if tokens are valid: true, expires at: 1763131767555
[debug] [2025-11-14T13:50:34.662Z] Checked if tokens are valid: true, expires at: 1763131767555
[debug] [2025-11-14T13:50:34.662Z] >>> [apiv2][query] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) [none]
[debug] [2025-11-14T13:50:34.662Z] >>> [apiv2][body] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) {"release":{"name":"projects/credit-castor/releases/cloud.firestore/(default)","rulesetName":"projects/credit-castor/rulesets/25221ff3-5c7e-422b-b4b4-f88046862594"}}
[debug] [2025-11-14T13:50:35.130Z] <<< [apiv2][status] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) 200
