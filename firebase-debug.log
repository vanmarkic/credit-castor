[debug] [2025-11-14T13:17:31.056Z] ----------------------------------------------------------------------
[debug] [2025-11-14T13:17:31.057Z] Command:       /Users/dragan/.nvm/versions/node/v20.19.2/bin/node /Users/dragan/.nvm/versions/node/v20.19.2/bin/firebase deploy --only firestore:rules
[debug] [2025-11-14T13:17:31.058Z] CLI Version:   14.24.2
[debug] [2025-11-14T13:17:31.058Z] Platform:      darwin
[debug] [2025-11-14T13:17:31.058Z] Node Version:  v20.19.2
[debug] [2025-11-14T13:17:31.058Z] Time:          Fri Nov 14 2025 14:17:31 GMT+0100 (Central European Standard Time)
[debug] [2025-11-14T13:17:31.058Z] ----------------------------------------------------------------------
[debug] 
[debug] [2025-11-14T13:17:31.166Z] > command requires scopes: ["email","openid","https://www.googleapis.com/auth/cloudplatformprojects.readonly","https://www.googleapis.com/auth/firebase","https://www.googleapis.com/auth/cloud-platform"]
[debug] [2025-11-14T13:17:31.167Z] > authorizing via signed-in user (drag.markovic@gmail.com)
[debug] [2025-11-14T13:17:31.167Z] [iam] checking project credit-castor for permissions ["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]
[debug] [2025-11-14T13:17:31.167Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:31.167Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:31.168Z] >>> [apiv2][query] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions [none]
[debug] [2025-11-14T13:17:31.168Z] >>> [apiv2][(partial)header] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions x-goog-quota-user=projects/credit-castor
[debug] [2025-11-14T13:17:31.168Z] >>> [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[debug] [2025-11-14T13:17:31.872Z] <<< [apiv2][status] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions 200
[debug] [2025-11-14T13:17:31.873Z] <<< [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[info] 
[info] === Deploying to 'credit-castor'...
[info] 
[info] i  deploying firestore 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[debug] [2025-11-14T13:17:31.876Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:31.876Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:31.876Z] >>> [apiv2][query] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) [none]
[debug] [2025-11-14T13:17:32.010Z] <<< [apiv2][status] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) 200
[debug] [2025-11-14T13:17:32.010Z] <<< [apiv2][body] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) {"name":"projects/credit-castor/databases/(default)","uid":"29ced56d-581f-4c7a-80f3-35b9912f95e8","createTime":"2025-11-11T23:32:12.816385Z","updateTime":"2025-11-11T23:32:12.816385Z","locationId":"eur3","type":"FIRESTORE_NATIVE","concurrencyMode":"PESSIMISTIC","versionRetentionPeriod":"3600s","earliestVersionTime":"2025-11-14T12:17:32.049384Z","appEngineIntegrationMode":"DISABLED","keyPrefix":"e","pointInTimeRecoveryEnablement":"POINT_IN_TIME_RECOVERY_DISABLED","deleteProtectionState":"DELETE_PROTECTION_DISABLED","databaseEdition":"STANDARD","freeTier":true,"realtimeUpdatesMode":"REALTIME_UPDATES_MODE_ENABLED","etag":"ILCjyo/d8ZADMIqS+JCm65AD"}
[info] i  firestore: reading indexes from firestore.indexes.json... 
[info] i  cloud.firestore: checking firestore.rules for compilation errors... 
[debug] [2025-11-14T13:17:32.012Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:32.012Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:32.013Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test [none]
[debug] [2025-11-14T13:17:32.013Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test [omitted]
[debug] [2025-11-14T13:17:32.736Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test 200
[debug] [2025-11-14T13:17:32.737Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test {}
[info] ✔  cloud.firestore: rules file firestore.rules compiled successfully 
[debug] [2025-11-14T13:17:32.739Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:32.740Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:32.742Z] >>> [apiv2][query] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases pageSize=10&pageToken=
[debug] [2025-11-14T13:17:33.460Z] <<< [apiv2][status] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases 200
[debug] [2025-11-14T13:17:33.461Z] <<< [apiv2][body] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases {"releases":[{"name":"projects/credit-castor/releases/cloud.firestore","rulesetName":"projects/credit-castor/rulesets/fa589146-4111-494d-9431-1fad87540144","createTime":"2025-11-11T23:32:19.686496Z","updateTime":"2025-11-14T13:13:19.434349Z"}]}
[debug] [2025-11-14T13:17:33.461Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:33.461Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:33.462Z] >>> [apiv2][query] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/fa589146-4111-494d-9431-1fad87540144 [none]
[debug] [2025-11-14T13:17:34.137Z] <<< [apiv2][status] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/fa589146-4111-494d-9431-1fad87540144 200
[debug] [2025-11-14T13:17:34.137Z] <<< [apiv2][body] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/fa589146-4111-494d-9431-1fad87540144 [omitted]
[info] i  firestore: uploading rules firestore.rules... 
[debug] [2025-11-14T13:17:34.137Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:34.137Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:34.138Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets [none]
[debug] [2025-11-14T13:17:34.138Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets [omitted]
[debug] [2025-11-14T13:17:34.549Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets 200
[debug] [2025-11-14T13:17:34.549Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets {"name":"projects/credit-castor/rulesets/95ba754e-b421-4536-825b-eb661cb7fcf6","source":{"files":[{"content":"rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Users collection - store custom authentication data\n    match /users/{userId} {\n      // Anyone can create a new user (for registration)\n      allow create: if true;\n\n      // Users can only read their own data\n      allow read: if request.auth != null || request.resource.data.email == userId.replace('_', '@').replace('_', '.');\n\n      // Users cannot update/delete (security measure)\n      allow update, delete: if false;\n    }\n\n    // Projects collection - shared project data\n    match /projects/{projectId} {\n      // Allow read if unlocked (we check unlock state in the app)\n      allow read: if true;\n\n      // Helper function to validate TravauxCommuns structure\n      function isValidTravauxCommuns(travauxCommuns) {\n        // enabled must be boolean if present\n        let enabledValid = !exists(travauxCommuns.enabled) || travauxCommuns.enabled is bool;\n        \n        // If items exist, they must be a list\n        // Note: Detailed item structure validation (label, sqm, cascoPricePerSqm, parachevementPricePerSqm, amount)\n        // happens in the application layer. Firestore Security Rules don't support iterating through lists\n        // to validate individual items, so we only validate that items is a list if present.\n        let itemsValid = !exists(travauxCommuns.items) || travauxCommuns.items is list;\n        \n        return enabledValid && itemsValid;\n      }\n\n      // Helper function to validate ProjectParams structure\n      function isValidProjectParams() {\n        // If projectParams doesn't exist, validation passes (for partial updates)\n        return !exists(request.resource.data.projectParams) || \n               ((!exists(request.resource.data.projectParams.maxTotalLots) || \n                 (request.resource.data.projectParams.maxTotalLots is int && \n                  request.resource.data.projectParams.maxTotalLots > 0)) &&\n                (!exists(request.resource.data.projectParams.travauxCommuns) || \n                 isValidTravauxCommuns(request.resource.data.projectParams.travauxCommuns)));\n      }\n\n      // Allow write if lastModifiedBy is set (custom auth system) - must be a non-empty string\n      // OR if Firebase Auth user is authenticated\n      // Also validate projectParams structure if present\n      allow write: if ((exists(request.resource.data.lastModifiedBy) && \n                        request.resource.data.lastModifiedBy is string && \n                        request.resource.data.lastModifiedBy.size() > 0) || \n                       request.auth != null) &&\n                     isValidProjectParams();\n      \n      // TEMPORARY: Debug rule to see what's being sent\n      // This will help diagnose the permission issue\n      // allow write: if true; // DEBUG ONLY - REMOVE AFTER TESTING\n\n      // Participants subcollection - individual participant documents\n      match /participants/{participantId} {\n        // Allow read if unlocked (same as parent project)\n        allow read: if true;\n\n        // Helper function to validate Participant structure\n        function isValidParticipant() {\n          // lotsOwned must be an array if present\n          let lotsOwnedValid = !exists(request.resource.data.lotsOwned) || \n                               request.resource.data.lotsOwned is list;\n          // enabled must be boolean if present\n          let enabledValid = !exists(request.resource.data.enabled) || \n                            request.resource.data.enabled is bool;\n          return lotsOwnedValid && enabledValid;\n        }\n\n        // Allow write if lastModifiedBy is set (custom auth system) - must be a non-empty string\n        // OR if Firebase Auth user is authenticated\n        // Also validate participant structure\n        allow write: if ((exists(request.resource.data.lastModifiedBy) && \n                          request.resource.data.lastModifiedBy is string && \n                          request.resource.data.lastModifiedBy.size() > 0) || \n                         request.auth != null) &&\n                       isValidParticipant();\n      }\n    }\n\n    // Presence collection - for tracking active users\n    match /presence/{sessionId} {\n      allow read, write: if true; // Presence is ephemeral and not sensitive\n    }\n\n    // Edit locks collection - collaborative editing coordination\n    match /editLocks/{projectId} {\n      // Allow anyone to read locks (to check if a project is locked)\n      allow read: if true;\n\n      // Allow anyone to create/update/delete locks\n      // Transaction-based atomicity in the code prevents race conditions\n      allow create, update, delete: if true;\n    }\n  }\n}","name":"firestore.rules"}]},"createTime":"2025-11-14T13:17:34.455439Z","metadata":{"services":["cloud.firestore"]}}
[debug] [2025-11-14T13:17:34.549Z] [rules] created ruleset projects/credit-castor/rulesets/95ba754e-b421-4536-825b-eb661cb7fcf6
[debug] [2025-11-14T13:17:34.549Z] [rules] releasing cloud.firestore/(default) with ruleset projects/credit-castor/rulesets/95ba754e-b421-4536-825b-eb661cb7fcf6
[debug] [2025-11-14T13:17:34.549Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:34.549Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:34.549Z] >>> [apiv2][query] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) [none]
[debug] [2025-11-14T13:17:34.549Z] >>> [apiv2][body] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) {"release":{"name":"projects/credit-castor/releases/cloud.firestore/(default)","rulesetName":"projects/credit-castor/rulesets/95ba754e-b421-4536-825b-eb661cb7fcf6"}}
[debug] [2025-11-14T13:17:35.432Z] <<< [apiv2][status] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) 200
[debug] [2025-11-14T13:17:54.595Z] ----------------------------------------------------------------------
[debug] [2025-11-14T13:17:54.597Z] Command:       /Users/dragan/.nvm/versions/node/v20.19.2/bin/node /Users/dragan/.nvm/versions/node/v20.19.2/bin/firebase deploy --only firestore:rules
[debug] [2025-11-14T13:17:54.597Z] CLI Version:   14.24.2
[debug] [2025-11-14T13:17:54.597Z] Platform:      darwin
[debug] [2025-11-14T13:17:54.597Z] Node Version:  v20.19.2
[debug] [2025-11-14T13:17:54.597Z] Time:          Fri Nov 14 2025 14:17:54 GMT+0100 (Central European Standard Time)
[debug] [2025-11-14T13:17:54.597Z] ----------------------------------------------------------------------
[debug] 
[debug] [2025-11-14T13:17:54.679Z] > command requires scopes: ["email","openid","https://www.googleapis.com/auth/cloudplatformprojects.readonly","https://www.googleapis.com/auth/firebase","https://www.googleapis.com/auth/cloud-platform"]
[debug] [2025-11-14T13:17:54.680Z] > authorizing via signed-in user (drag.markovic@gmail.com)
[debug] [2025-11-14T13:17:54.680Z] [iam] checking project credit-castor for permissions ["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]
[debug] [2025-11-14T13:17:54.680Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:54.681Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:54.681Z] >>> [apiv2][query] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions [none]
[debug] [2025-11-14T13:17:54.681Z] >>> [apiv2][(partial)header] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions x-goog-quota-user=projects/credit-castor
[debug] [2025-11-14T13:17:54.681Z] >>> [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[debug] [2025-11-14T13:17:55.440Z] <<< [apiv2][status] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions 200
[debug] [2025-11-14T13:17:55.440Z] <<< [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/credit-castor:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[info] 
[info] === Deploying to 'credit-castor'...
[info] 
[info] i  deploying firestore 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[debug] [2025-11-14T13:17:55.443Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:55.443Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:55.443Z] >>> [apiv2][query] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) [none]
[debug] [2025-11-14T13:17:55.551Z] <<< [apiv2][status] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) 200
[debug] [2025-11-14T13:17:55.551Z] <<< [apiv2][body] GET https://firestore.googleapis.com/v1/projects/credit-castor/databases/(default) {"name":"projects/credit-castor/databases/(default)","uid":"29ced56d-581f-4c7a-80f3-35b9912f95e8","createTime":"2025-11-11T23:32:12.816385Z","updateTime":"2025-11-11T23:32:12.816385Z","locationId":"eur3","type":"FIRESTORE_NATIVE","concurrencyMode":"PESSIMISTIC","versionRetentionPeriod":"3600s","earliestVersionTime":"2025-11-14T12:17:55.592242Z","appEngineIntegrationMode":"DISABLED","keyPrefix":"e","pointInTimeRecoveryEnablement":"POINT_IN_TIME_RECOVERY_DISABLED","deleteProtectionState":"DELETE_PROTECTION_DISABLED","databaseEdition":"STANDARD","freeTier":true,"realtimeUpdatesMode":"REALTIME_UPDATES_MODE_ENABLED","etag":"IK2c55rd8ZADMIqS+JCm65AD"}
[info] i  firestore: reading indexes from firestore.indexes.json... 
[info] i  cloud.firestore: checking firestore.rules for compilation errors... 
[debug] [2025-11-14T13:17:55.553Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:55.553Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:55.553Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test [none]
[debug] [2025-11-14T13:17:55.553Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test [omitted]
[debug] [2025-11-14T13:17:56.278Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test 200
[debug] [2025-11-14T13:17:56.278Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor:test {"issues":[{"sourcePosition":{"fileName":"firestore.rules","line":25,"column":29,"currentOffset":898,"endOffset":903},"description":"Invalid function name: exists.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":31,"column":27,"currentOffset":1365,"endOffset":1370},"description":"Invalid function name: exists.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":37,"column":16,"currentOffset":1564,"endOffset":1583},"description":"Unused function: isValidProjectParams.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":39,"column":17,"currentOffset":1688,"endOffset":1693},"description":"Invalid function name: exists.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":39,"column":24,"currentOffset":1695,"endOffset":1701},"description":"Invalid variable name: request.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":40,"column":19,"currentOffset":1754,"endOffset":1759},"description":"Invalid function name: exists.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":40,"column":26,"currentOffset":1761,"endOffset":1767},"description":"Invalid variable name: request.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":41,"column":19,"currentOffset":1833,"endOffset":1839},"description":"Invalid variable name: request.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":42,"column":19,"currentOffset":1911,"endOffset":1917},"description":"Invalid variable name: request.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":43,"column":19,"currentOffset":1987,"endOffset":1992},"description":"Invalid function name: exists.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":43,"column":26,"currentOffset":1994,"endOffset":2000},"description":"Invalid variable name: request.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":44,"column":40,"currentOffset":2089,"endOffset":2095},"description":"Invalid variable name: request.","severity":"WARNING"}]}
[warn] ⚠  [W] 25:29 - Invalid function name: exists. 
[warn] ⚠  [W] 31:27 - Invalid function name: exists. 
[warn] ⚠  [W] 37:16 - Unused function: isValidProjectParams. 
[warn] ⚠  [W] 39:17 - Invalid function name: exists. 
[warn] ⚠  [W] 39:24 - Invalid variable name: request. 
[warn] ⚠  [W] 40:19 - Invalid function name: exists. 
[warn] ⚠  [W] 40:26 - Invalid variable name: request. 
[warn] ⚠  [W] 41:19 - Invalid variable name: request. 
[warn] ⚠  [W] 42:19 - Invalid variable name: request. 
[warn] ⚠  [W] 43:19 - Invalid function name: exists. 
[warn] ⚠  [W] 43:26 - Invalid variable name: request. 
[warn] ⚠  [W] 44:40 - Invalid variable name: request. 
[info] ✔  cloud.firestore: rules file firestore.rules compiled successfully 
[debug] [2025-11-14T13:17:56.281Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:56.281Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:56.282Z] >>> [apiv2][query] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases pageSize=10&pageToken=
[debug] [2025-11-14T13:17:56.970Z] <<< [apiv2][status] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases 200
[debug] [2025-11-14T13:17:56.970Z] <<< [apiv2][body] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/releases {"releases":[{"name":"projects/credit-castor/releases/cloud.firestore","rulesetName":"projects/credit-castor/rulesets/95ba754e-b421-4536-825b-eb661cb7fcf6","createTime":"2025-11-11T23:32:19.686496Z","updateTime":"2025-11-14T13:17:35.393682Z"}]}
[debug] [2025-11-14T13:17:56.970Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:56.971Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:56.971Z] >>> [apiv2][query] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/95ba754e-b421-4536-825b-eb661cb7fcf6 [none]
[debug] [2025-11-14T13:17:57.634Z] <<< [apiv2][status] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/95ba754e-b421-4536-825b-eb661cb7fcf6 200
[debug] [2025-11-14T13:17:57.634Z] <<< [apiv2][body] GET https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets/95ba754e-b421-4536-825b-eb661cb7fcf6 [omitted]
[info] i  firestore: uploading rules firestore.rules... 
[debug] [2025-11-14T13:17:57.635Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:57.635Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:57.635Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets [none]
[debug] [2025-11-14T13:17:57.636Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets [omitted]
[debug] [2025-11-14T13:17:57.997Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets 200
[debug] [2025-11-14T13:17:57.997Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/credit-castor/rulesets {"name":"projects/credit-castor/rulesets/77e31b1d-bd9f-4b62-a7d0-83b79d947d5e","source":{"files":[{"content":"rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Users collection - store custom authentication data\n    match /users/{userId} {\n      // Anyone can create a new user (for registration)\n      allow create: if true;\n\n      // Users can only read their own data\n      allow read: if request.auth != null || request.resource.data.email == userId.replace('_', '@').replace('_', '.');\n\n      // Users cannot update/delete (security measure)\n      allow update, delete: if false;\n    }\n\n    // Projects collection - shared project data\n    match /projects/{projectId} {\n      // Allow read if unlocked (we check unlock state in the app)\n      allow read: if true;\n\n      // Helper function to validate TravauxCommuns structure\n      function isValidTravauxCommuns(travauxCommuns) {\n        // enabled must be boolean if present\n        let enabledValid = !exists(travauxCommuns.enabled) || travauxCommuns.enabled is bool;\n        \n        // If items exist, they must be a list\n        // Note: Detailed item structure validation (label, sqm, cascoPricePerSqm, parachevementPricePerSqm, amount)\n        // happens in the application layer. Firestore Security Rules don't support iterating through lists\n        // to validate individual items, so we only validate that items is a list if present.\n        let itemsValid = !exists(travauxCommuns.items) || travauxCommuns.items is list;\n        \n        return enabledValid && itemsValid;\n      }\n\n      // Helper function to validate ProjectParams structure\n      function isValidProjectParams() {\n        // If projectParams doesn't exist, validation passes (for partial updates)\n        return !exists(request.resource.data.projectParams) || \n               ((!exists(request.resource.data.projectParams.maxTotalLots) || \n                 (request.resource.data.projectParams.maxTotalLots is int && \n                  request.resource.data.projectParams.maxTotalLots > 0)) &&\n                (!exists(request.resource.data.projectParams.travauxCommuns) || \n                 isValidTravauxCommuns(request.resource.data.projectParams.travauxCommuns)));\n      }\n\n      // TEMPORARY: Debug rule - allow all writes to test if rules are the issue\n      // TODO: Remove this and restore proper rules after testing\n      allow write: if true;\n      \n      // Original rule (commented out for debugging):\n      // Allow write if lastModifiedBy is set (custom auth system) - must be a non-empty string\n      // OR if Firebase Auth user is authenticated\n      // Also validate projectParams structure if present\n      // allow write: if ((exists(request.resource.data.lastModifiedBy) && \n      //                   request.resource.data.lastModifiedBy is string && \n      //                   request.resource.data.lastModifiedBy.size() > 0) || \n      //                 request.auth != null) &&\n      //               isValidProjectParams();\n\n      // Participants subcollection - individual participant documents\n      match /participants/{participantId} {\n        // Allow read if unlocked (same as parent project)\n        allow read: if true;\n\n        // Helper function to validate Participant structure\n        function isValidParticipant() {\n          // lotsOwned must be an array if present\n          let lotsOwnedValid = !exists(request.resource.data.lotsOwned) || \n                               request.resource.data.lotsOwned is list;\n          // enabled must be boolean if present\n          let enabledValid = !exists(request.resource.data.enabled) || \n                            request.resource.data.enabled is bool;\n          return lotsOwnedValid && enabledValid;\n        }\n\n        // Allow write if lastModifiedBy is set (custom auth system) - must be a non-empty string\n        // OR if Firebase Auth user is authenticated\n        // Also validate participant structure\n        allow write: if ((exists(request.resource.data.lastModifiedBy) && \n                          request.resource.data.lastModifiedBy is string && \n                          request.resource.data.lastModifiedBy.size() > 0) || \n                         request.auth != null) &&\n                       isValidParticipant();\n      }\n    }\n\n    // Presence collection - for tracking active users\n    match /presence/{sessionId} {\n      allow read, write: if true; // Presence is ephemeral and not sensitive\n    }\n\n    // Edit locks collection - collaborative editing coordination\n    match /editLocks/{projectId} {\n      // Allow anyone to read locks (to check if a project is locked)\n      allow read: if true;\n\n      // Allow anyone to create/update/delete locks\n      // Transaction-based atomicity in the code prevents race conditions\n      allow create, update, delete: if true;\n    }\n  }\n}","name":"firestore.rules"}]},"createTime":"2025-11-14T13:17:57.925007Z","metadata":{"services":["cloud.firestore"]}}
[debug] [2025-11-14T13:17:57.997Z] [rules] created ruleset projects/credit-castor/rulesets/77e31b1d-bd9f-4b62-a7d0-83b79d947d5e
[debug] [2025-11-14T13:17:57.998Z] [rules] releasing cloud.firestore/(default) with ruleset projects/credit-castor/rulesets/77e31b1d-bd9f-4b62-a7d0-83b79d947d5e
[debug] [2025-11-14T13:17:57.998Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:57.998Z] Checked if tokens are valid: true, expires at: 1763128583975
[debug] [2025-11-14T13:17:57.998Z] >>> [apiv2][query] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) [none]
[debug] [2025-11-14T13:17:57.998Z] >>> [apiv2][body] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) {"release":{"name":"projects/credit-castor/releases/cloud.firestore/(default)","rulesetName":"projects/credit-castor/rulesets/77e31b1d-bd9f-4b62-a7d0-83b79d947d5e"}}
[debug] [2025-11-14T13:17:58.880Z] <<< [apiv2][status] PATCH https://firebaserules.googleapis.com/v1/projects/credit-castor/releases/cloud.firestore/(default) 200
