rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users collection - store custom authentication data
    match /users/{userId} {
      // Anyone can create a new user (for registration)
      allow create: if true;

      // Users can only read their own data
      allow read: if request.auth != null || request.resource.data.email == userId.replace('_', '@').replace('_', '.');

      // Users cannot update/delete (security measure)
      allow update, delete: if false;
    }

    // Projects collection - shared project data
    match /projects/{projectId} {
      // Allow read if unlocked (we check unlock state in the app)
      allow read: if true;

      // Helper function to validate ProjectParams structure
      function isValidProjectParams() {
        // If projectParams doesn't exist, validation passes (for partial updates)
        return !exists(request.resource.data.projectParams) || 
               (!exists(request.resource.data.projectParams.maxTotalLots) || 
                (request.resource.data.projectParams.maxTotalLots is int && 
                 request.resource.data.projectParams.maxTotalLots > 0));
      }

      // Allow write only if user is authenticated (has unlocked)
      // Also validate projectParams structure
      allow write: if (request.auth != null || request.resource.data.lastModifiedBy != null) &&
                     isValidProjectParams();

      // Participants subcollection - individual participant documents
      match /participants/{participantId} {
        // Allow read if unlocked (same as parent project)
        allow read: if true;

        // Helper function to validate Participant structure
        function isValidParticipant() {
          // lotsOwned must be an array if present
          let lotsOwnedValid = !exists(request.resource.data.lotsOwned) || 
                               request.resource.data.lotsOwned is list;
          // enabled must be boolean if present
          let enabledValid = !exists(request.resource.data.enabled) || 
                            request.resource.data.enabled is bool;
          return lotsOwnedValid && enabledValid;
        }

        // Allow write only if user is authenticated (has unlocked)
        // Also validate participant structure
        allow write: if (request.auth != null || request.resource.data.lastModifiedBy != null) &&
                       isValidParticipant();
      }
    }

    // Presence collection - for tracking active users
    match /presence/{sessionId} {
      allow read, write: if true; // Presence is ephemeral and not sensitive
    }

    // Edit locks collection - collaborative editing coordination
    match /editLocks/{projectId} {
      // Allow anyone to read locks (to check if a project is locked)
      allow read: if true;

      // Allow anyone to create/update/delete locks
      // Transaction-based atomicity in the code prevents race conditions
      allow create, update, delete: if true;
    }
  }
}